# Orderly Network Scripts

A collection of JavaScript scripts for interacting with the Orderly Network API, including account registration, account checking, Orderly Key management, deposits, withdrawals, and order management.

## Installation

```bash
npm install
```

## Configuration

Create a `.env` file in the root directory (or copy from `.env.example`):

```bash
# Orderly API Configuration
ORDERLY_API_URL=https://api.orderly.org  # or https://testnet-api.orderly.org for testnet
CHAIN_ID=80001                            # Example: Polygon Mumbai testnet
BROKER_ID=woofi_pro                       # Your broker ID

# Wallet Configuration (required for registration, key operations, and deposits)
PRIVATE_KEY=your_private_key_here         # Your Ethereum wallet private key

# Deposit Configuration (optional)
RPC_URL=https://rpc.ankr.com/eth_sepolia  # RPC URL for on-chain operations
ORDERLY_VAULT=0x...                       # Override Vault address (auto-detected by chain ID)
DEPOSIT_AMOUNT=100                        # Deposit amount for deposit script

# Withdrawal Configuration (required for withdrawals)
ACCOUNT_ID=0x...                          # Orderly account ID (or use ORDERLY_ACCOUNT_ID)
ORDERLY_KEY=ed25519:...                  # Orderly public key (generated by add-orderly-key.js)
ORDERLY_PRIVATE_KEY=0x...                 # Orderly private key in hex format (generated by add-orderly-key.js)
WITHDRAW_AMOUNT=50                        # Withdrawal amount
WITHDRAW_TOKEN=USDC                       # Token to withdraw
```

### Environment Variables

- `ORDERLY_API_URL`: Orderly API base URL (default: `https://api.orderly.org`)
- `CHAIN_ID`: The chain ID to use (default: `80001` for Polygon Mumbai testnet)
- `BROKER_ID`: Your broker ID (default: `woofi_pro`)
- `PRIVATE_KEY`: Your Ethereum wallet private key (required for registration, adding keys, deposits, and withdrawals)
- `ADDRESS`: Wallet address (optional, can be passed as CLI argument)
- `CHAIN_TYPE`: Chain type - `EVM` or `SOL` (default: `EVM`)
- `RPC_URL`: RPC URL for on-chain operations (optional, defaults provided per chain)
- `ACCOUNT_ID` or `ORDERLY_ACCOUNT_ID`: Orderly account ID (required for withdrawals and removing keys)
- `ORDERLY_KEY`: Orderly public key in format `ed25519:...` (required for withdrawals and removing keys, generated by `add-orderly-key.js`)
- `ORDERLY_PRIVATE_KEY`: Orderly private key in hex format (required for withdrawals and removing keys, generated by `add-orderly-key.js`)

## Scripts

### 1. Check Account (`check-account.js`)

Check if an Orderly account exists for a given wallet address and broker ID combination.

#### Usage

```bash
# Using npm script
npm run check <address> [brokerId] [chainType]

# Direct execution
node check-account.js <address> [brokerId] [chainType]

# Using environment variables
ADDRESS=0x1234... BROKER_ID=woofi_pro node check-account.js
```

#### Examples

```bash
# Check account with all parameters
npm run check 0x1234... "woofi_pro" EVM

# Check account using environment variables
ADDRESS=0x1234... BROKER_ID=woofi_pro CHAIN_TYPE=EVM npm run check

# Check account with default broker ID from .env
npm run check 0x1234...
```

#### Using as a Module

```javascript
const { checkAccountExists } = require("./check-account");

// Check if account exists
const exists = await checkAccountExists(
  "0x1234...", // wallet address
  "woofi_pro", // broker ID
  "EVM" // chain type: 'EVM' or 'SOL'
);

if (exists) {
  console.log("Account exists!");
} else {
  console.log("Account does not exist");
}
```

#### API Details

- **Endpoint**: `/v1/get_account`
- **Method**: GET
- **Parameters**:
  - `address` (required): Wallet address
  - `broker_id` (required): Broker ID
  - `chain_type` (optional): Chain type (EVM or SOL)

---

### 2. Register Account (`register-account.js`)

Register a new account on Orderly Network using a wallet address and broker ID.

#### Usage

```bash
# Using npm script (reads from .env file)
npm run register

# Direct execution
node register-account.js
```

#### Prerequisites

- `PRIVATE_KEY` must be set in `.env` file
- `BROKER_ID` must be set in `.env` file or defaults to `woofi_pro`
- `CHAIN_ID` must be set in `.env` file or defaults to `80001`

#### Examples

```bash
# Register with environment variables from .env
npm run register

# Register with inline environment variables
PRIVATE_KEY=0x... BROKER_ID=woofi_pro CHAIN_ID=80001 npm run register
```

#### Using as a Module

```javascript
const { registerAccount } = require("./register-account");
const { ethers } = require("ethers");

// Create wallet from private key
const wallet = new ethers.Wallet("your_private_key");

// Register account
const result = await registerAccount(
  wallet, // ethers.Wallet instance
  "woofi_pro", // broker ID (optional, defaults to BROKER_ID from env)
  80001 // chain ID (optional, defaults to CHAIN_ID from env)
);

console.log("Registration result:", result);
```

#### How It Works

1. Checks if an account already exists for the wallet address and broker ID combination
2. Fetches a registration nonce from the Orderly API
3. Creates an EIP-712 typed data message with:
   - Broker ID
   - Chain ID
   - Timestamp
   - Registration nonce
4. Signs the message using EIP-712 standard
5. Sends the registration request to Orderly API with the signature

#### Example Output

```
Registering account for address: 0x1234... with brokerId: woori_pro
Fetching registration nonce...
Registration nonce: 194528949540
Signing EIP-712 message...
Signature: 0xabcd...
Registering account...
Registration successful!
```

#### API Details

- **Get Nonce Endpoint**: `/v1/registration_nonce`
- **Register Endpoint**: `/v1/register_account`
- **Method**: POST
- **Request Body**:
  ```json
  {
    "message": {
      "brokerId": "string",
      "chainId": 80001,
      "timestamp": 1234567890,
      "registrationNonce": "string"
    },
    "signature": "0x...",
    "userAddress": "0x..."
  }
  ```

---

### 3. Add Orderly Key (`add-orderly-key.js`)

Add/announce an Orderly Key for an account. This allows the account to use Orderly Key-based authentication.

#### Usage

```bash
# Using npm script
npm run add-key [brokerId] [chainId]

# Direct execution
node add-orderly-key.js [brokerId] [chainId]
```

#### Prerequisites

- `PRIVATE_KEY` must be set in `.env` file
- Account must be registered on Orderly Network
- Note: Orderly Key is automatically generated internally (ed25519 key pair)

#### Examples

```bash
# Add Orderly Key with all parameters
npm run add-key "woofi_pro" 80001

# Add Orderly Key using default broker ID and chain ID
npm run add-key

# Add Orderly Key with inline environment variables
PRIVATE_KEY=0x... npm run add-key
```

#### Using as a Module

```javascript
const { addOrderlyKey } = require("./add-orderly-key");
const { ethers } = require("ethers");

// Create wallet from private key
const wallet = new ethers.Wallet("your_private_key");

// Add Orderly Key (key is generated automatically)
const result = await addOrderlyKey(
  wallet, // ethers.Wallet instance
  "woofi_pro", // broker ID (optional, defaults to BROKER_ID from env)
  80001 // chain ID (optional, defaults to CHAIN_ID from env)
);

console.log("Orderly Key added:", result);
console.log("Generated Orderly Key:", result.orderlyKey);
```

#### How It Works

1. Generates an ed25519 key pair internally
2. Encodes the public key in base58 format with "ed25519:" prefix
3. Creates an EIP-712 typed data message with:
   - Broker ID
   - Chain ID
   - Orderly Key (generated public key)
   - Scope (default: "read,trading")
   - Timestamp
   - Expiration (default: 365 days)
4. Signs the message using EIP-712 standard
5. Sends the add key request to Orderly API with the signature

#### Example Output

```
Adding Orderly Key for address: 0x1234... with brokerId: woori_pro
Orderly Key: ed25519:...
Signing EIP-712 message...
Signature: 0xabcd...
Announcing Orderly Key...
Orderly Key announcement successful!
```

#### API Details

- **Add Key Endpoint**: `/v1/orderly_key`
- **Method**: POST
- **Request Body**:
  ```json
  {
    "message": {
      "brokerId": "string",
      "chainId": 80001,
      "timestamp": 1234567890,
      "orderlyKey": "ed25519:..."
    },
    "signature": "0x...",
    "userAddress": "0x..."
  }
  ```

---

### 4. Deposit USDC (`deposit.js`)

Deposit USDC tokens to your Orderly account via the Vault smart contract on supported chains.

#### Usage

```bash
# Using npm script
npm run deposit <amount> [brokerId] [chainId]

# Direct execution
node deposit.js <amount> [brokerId] [chainId]

# With environment variables
DEPOSIT_AMOUNT=100 npm run deposit
```

#### Prerequisites

- `PRIVATE_KEY` must be set in `.env` file
- `RPC_URL` must be set in `.env` file for the chain you're using (or use default RPC URLs)
- Account must be registered on Orderly Network
- Sufficient USDC balance in your wallet
- Sufficient native token (ETH, etc.) for gas fees and deposit fee

#### Examples

```bash
# Deposit 100 USDC with all parameters
npm run deposit "100" "woofi_pro" 421614

# Deposit using environment variables
DEPOSIT_AMOUNT=100 npm run deposit

# Deposit on specific chain
npm run deposit "50" "woofi_pro" 84532
```

#### Using as a Module

```javascript
const { depositUSDC } = require("./deposit");
const { ethers } = require("ethers");

// Create wallet from private key
const wallet = new ethers.Wallet("your_private_key");

// Deposit USDC
const result = await depositUSDC(
  wallet, // ethers.Wallet instance
  "100", // amount in human-readable format
  "woofi_pro", // broker ID (optional, defaults to BROKER_ID from env)
  421614 // chain ID (optional, defaults to CHAIN_ID from env)
);

console.log("Deposit result:", result);
```

#### How It Works

1. Fetches the Orderly Vault contract address for the specified chain
2. Connects to the blockchain via RPC provider
3. Checks USDC balance in your wallet
4. Approves USDC spending by the Vault contract (if needed)
5. Prepares deposit data with:
   - Account ID (calculated from address and broker ID)
   - Broker hash (keccak256 of broker ID)
   - Token hash (keccak256 of "USDC")
   - Token amount (in smallest unit)
6. Calculates deposit fee using `getDepositFee`
7. Calls the Vault `deposit` function with deposit data and fee

#### Example Output

```
Depositing 100 USDC to Orderly account for address: 0x1234... with brokerId: woori_pro
Orderly Vault: 0x0EaC556c0C2321BA25b9DC01e4e3c95aD5CDCd2f
USDC decimals: 6
Amount in smallest unit: 100000000
Current USDC balance: 1000.0
Approving USDC transfer to Orderly Vault...
Approval confirmed
Deposit data prepared:
  Account ID: 0x...
  Broker Hash: 0x...
  Token Hash: 0x...
  Token Amount: 100000000
Calculating deposit fee...
Deposit fee: 0.0001 ETH
Depositing 100 USDC to Orderly Vault...
Transaction hash: 0xabcd...
Transaction confirmed in block: 12345678

Deposit successful!
Transaction Hash: 0xabcd...
Vault Address: 0x0EaC556c0C2321BA25b9DC01e4e3c95aD5CDCd2f
Amount: 100 USDC
```

#### Supported Chains

The deposit script supports all chains listed in the Orderly documentation:

- Ethereum (Mainnet & Sepolia)
- Arbitrum (One & Sepolia)
- Optimism (Mainnet & Sepolia)
- Base (Mainnet & Sepolia)
- Mantle (Mainnet & Sepolia)
- BNB Smart Chain (Mainnet & Testnet)

#### API Details

- **Vault Addresses**: Automatically selected based on chain ID from [Orderly addresses documentation](https://orderly.network/docs/build-on-omnichain/addresses)
- **Process**: On-chain transaction to Vault smart contract
- **Documentation**: Based on [Orderly deposit flow](https://orderly.network/docs/build-on-omnichain/user-flows/withdrawal-deposit)

---

### 5. Withdraw Funds (`withdraw.js`)

Withdraw funds from your Orderly account to your wallet on a specified chain.

#### Usage

```bash
# Using npm script
npm run withdraw <amount> [token] [targetChainId] [brokerId]

# Direct execution
node withdraw.js <amount> [token] [targetChainId] [brokerId]

# With environment variables
WITHDRAW_AMOUNT=50 WITHDRAW_TOKEN=USDC npm run withdraw
```

#### Prerequisites

- `PRIVATE_KEY` must be set in `.env` file
- `ACCOUNT_ID` or `ORDERLY_ACCOUNT_ID` must be set in `.env` file
- `ORDERLY_KEY` must be set in `.env` file (generated by `add-orderly-key.js`)
- `ORDERLY_PRIVATE_KEY` must be set in `.env` file (generated by `add-orderly-key.js`)
- Account must be registered on Orderly Network
- Orderly Key must be added to your account
- Sufficient balance in your Orderly account

#### Examples

```bash
# Withdraw 50 USDC to Arbitrum Sepolia
npm run withdraw "50" "USDC" 421614 "woofi_pro"

# Withdraw using environment variables
WITHDRAW_AMOUNT=100 WITHDRAW_TOKEN=USDC npm run withdraw

# Withdraw to specific chain
npm run withdraw "25" "USDC" 84532 "woofi_pro"
```

#### Using as a Module

```javascript
const { withdrawFunds } = require("./withdraw");
const { ethers } = require("ethers");

// Create wallet from private key
const wallet = new ethers.Wallet("your_private_key");

// Withdraw funds
const result = await withdrawFunds(
  wallet, // ethers.Wallet instance
  "50", // amount in human-readable format
  "USDC", // token symbol (optional, defaults to "USDC")
  421614, // target chain ID (optional, defaults to CHAIN_ID from env)
  "woofi_pro" // broker ID (optional, defaults to BROKER_ID from env)
);

console.log("Withdrawal result:", result);
```

#### How It Works

1. Fetches withdrawal nonce from Orderly API (requires Orderly authentication)
2. Converts human-readable amount to smallest unit based on token decimals
3. Creates an EIP-712 typed data message with:
   - Broker ID
   - Chain ID (target chain for withdrawal)
   - Receiver address (your wallet address)
   - Token symbol
   - Amount (in smallest unit as uint256)
   - Withdrawal nonce
   - Timestamp
4. Signs the message using EIP-712 standard with your wallet
5. Sends the withdrawal request to Orderly API with Orderly authentication headers
6. Orderly Network processes the withdrawal and sends funds to your wallet on the target chain

#### Example Output

```
Withdrawing 50 USDC from Orderly account for address: 0x1234... with brokerId: woori_pro
Target chain ID: 421614
Account ID: 0x...
Token: USDC, Decimals: 6
Amount: 50 USDC = 50000000 (smallest unit)
Fetching withdrawal nonce...
Withdrawal nonce: 12345
Signing EIP-712 message...
Signature: 0xabcd...
Creating withdrawal request...
Withdrawal request successful!
Response: {
  "success": true,
  "data": {
    "withdraw_id": 123
  }
}

Withdrawal request submitted successfully!
Amount: 50 USDC
Target Chain ID: 421614
Withdrawal Nonce: 12345

Note: The withdrawal will be processed by Orderly Network.
Check your wallet on the target chain after processing completes.
```

#### API Details

- **Get Nonce Endpoint**: `/v1/withdraw_nonce` (GET, requires Orderly authentication)
- **Withdraw Endpoint**: `/v1/withdraw_request` (POST, requires Orderly authentication)
- **Verifying Contract**: `0x6F7a338F2aA472838dEFD3283eB360d4Dff5D203` (different from other operations)
- **Authentication**: Uses Orderly API authentication (orderly-timestamp, orderly-account-id, orderly-key, orderly-signature)
- **Documentation**: Based on [Orderly withdrawal flow](https://orderly.network/docs/build-on-omnichain/user-flows/withdrawal-deposit) and [Create Withdraw Request API](https://orderly.network/docs/build-on-omnichain/evm-api/restful-api/private/create-withdraw-request)

---

### 6. Remove Orderly Key (`remove-orderly-key.js`)

Remove/revoke an Orderly Key from your account.

#### Usage

```bash
# Using npm script
npm run remove-key <orderlyKeyToRemove>

# Direct execution
node remove-orderly-key.js <orderlyKeyToRemove>

# With environment variable
ORDERLY_KEY_TO_REMOVE=ed25519:... npm run remove-key
```

#### Prerequisites

- `ACCOUNT_ID` or `ORDERLY_ACCOUNT_ID` must be set in `.env` file
- `ORDERLY_KEY` must be set in `.env` file (the key used for authentication)
- `ORDERLY_PRIVATE_KEY` must be set in `.env` file (for signing the request)
- Account must be registered on Orderly Network
- Orderly Key must be added to your account

#### Examples

```bash
# Remove a specific Orderly Key
npm run remove-key "ed25519:..."

# Remove using environment variable
ORDERLY_KEY_TO_REMOVE=ed25519:... npm run remove-key
```

#### Using as a Module

```javascript
const { removeOrderlyKey } = require("./remove-orderly-key");
const { hexToPrivateKey } = require("./orderly-auth");

const accountId = process.env.ACCOUNT_ID;
const orderlyKey = process.env.ORDERLY_KEY;
const orderlyPrivateKey = hexToPrivateKey(process.env.ORDERLY_PRIVATE_KEY);

// Remove Orderly Key
const result = await removeOrderlyKey(
  "ed25519:...", // Orderly Key to remove
  accountId,
  orderlyKey,
  orderlyPrivateKey
);

console.log("Removal result:", result);
```

#### How It Works

1. Creates an authenticated request using Orderly API authentication
2. Normalizes the request message (timestamp + method + path + body)
3. Signs the message with your Orderly private key (ed25519)
4. Sends the removal request to Orderly API with authentication headers
5. The Orderly Key is deactivated and can no longer be used

#### Example Output

```
Removing Orderly Key: ed25519:...
Account ID: 0x...
Removing Orderly Key...
Orderly Key removed successfully!
Response: {
  "success": true,
  "timestamp": 1702989203989
}

Orderly Key removed successfully!
Removed Key: ed25519:...
```

#### API Details

- **Remove Key Endpoint**: `/v1/client/remove_orderly_key` (POST)
- **Authentication**: Uses Orderly API authentication (orderly-timestamp, orderly-account-id, orderly-key, orderly-signature)
- **Request Body**:
  ```json
  {
    "orderly_key": "ed25519:..."
  }
  ```
- **Documentation**: Based on [Remove Orderly Key API](https://orderly.network/docs/build-on-omnichain/evm-api/restful-api/private/remove-orderly-key)

---

### 7. Create Order (`create-order.js`)

Create a new order on Orderly Network.

#### Usage

```bash
# Using npm script
npm run create-order <symbol> <orderType> <side> [orderPrice] [orderQuantity] [orderAmount]

# Direct execution
node create-order.js <symbol> <orderType> <side> [orderPrice] [orderQuantity] [orderAmount]
```

#### Prerequisites

- `ACCOUNT_ID` or `ORDERLY_ACCOUNT_ID` must be set in `.env` file
- `ORDERLY_KEY` must be set in `.env` file (generated by `add-orderly-key.js`)
- `ORDERLY_PRIVATE_KEY` must be set in `.env` file (generated by `add-orderly-key.js`)
- Account must be registered on Orderly Network
- Orderly Key must be added to your account with `trading` scope
- Sufficient balance in your Orderly account

#### Examples

```bash
# LIMIT BUY order
npm run create-order "PERP_ETH_USDC" "LIMIT" "BUY" 2000 0.1

# MARKET BUY order (using orderAmount)
npm run create-order "PERP_ETH_USDC" "MARKET" "BUY" undefined undefined 100

# LIMIT SELL order
npm run create-order "PERP_ETH_USDC" "LIMIT" "SELL" 2100 0.05

# IOC BUY order
npm run create-order "PERP_ETH_USDC" "IOC" "BUY" 2000 0.1
```

#### Using as a Module

```javascript
const { createOrder } = require("./create-order");
const { hexToPrivateKey } = require("./orderly-auth");

const accountId = process.env.ACCOUNT_ID;
const orderlyKey = process.env.ORDERLY_KEY;
const orderlyPrivateKey = hexToPrivateKey(process.env.ORDERLY_PRIVATE_KEY);

// Create LIMIT order
const result = await createOrder(
  {
    symbol: "PERP_ETH_USDC",
    orderType: "LIMIT",
    side: "BUY",
    orderPrice: 2000,
    orderQuantity: 0.1,
  },
  accountId,
  orderlyKey,
  orderlyPrivateKey
);

console.log("Order created:", result.orderId);
```

#### How It Works

1. Validates required parameters (symbol, orderType, side)
2. Validates order type-specific requirements:
   - `LIMIT`, `IOC`, `FOK`, `POST_ONLY` require `orderPrice`
   - `MARKET`, `BID`, `ASK` BUY orders use `orderAmount`
   - `MARKET`, `BID`, `ASK` SELL orders use `orderQuantity`
3. Builds the order request body with all parameters
4. Creates an authenticated request using Orderly API authentication
5. Signs the message with your Orderly private key (ed25519)
6. Sends a POST request to Orderly API with authentication headers
7. Returns the created order details including order ID

#### Example Output

```
Creating LIMIT BUY order for PERP_ETH_USDC...
Order created successfully!
Response: {
  "success": true,
  "timestamp": 1702989203989,
  "data": {
    "order_id": 12345,
    "client_order_id": "custom-id-123",
    "symbol": "PERP_ETH_USDC",
    "side": "BUY",
    "order_type": "LIMIT",
    "order_price": 2000,
    "order_quantity": 0.1,
    "status": "NEW"
  }
}

Order created successfully!
Order ID: 12345
Client Order ID: custom-id-123
```

#### API Details

- **Create Order Endpoint**: `POST /v1/order`
- **Authentication**: Uses Orderly API authentication (orderly-timestamp, orderly-account-id, orderly-key, orderly-signature)
- **Required Parameters**:
  - `symbol` (string): Trading symbol (e.g., "PERP_ETH_USDC")
  - `order_type` (string): Order type - "LIMIT", "MARKET", "IOC", "FOK", "POST_ONLY", "ASK", "BID"
  - `side` (string): Order side - "BUY" or "SELL"
- **Conditional Parameters**:
  - `order_price` (number): Required for LIMIT, IOC, FOK, POST_ONLY orders
  - `order_quantity` (number): Quantity in base currency (required for SELL orders or LIMIT orders)
  - `order_amount` (number): Amount in quote currency (required for MARKET/BID/ASK BUY orders)
- **Optional Parameters**:
  - `visible_quantity` (number): Visible quantity on orderbook
  - `reduce_only` (boolean): Reduce only flag
  - `slippage` (number): Slippage tolerance for MARKET orders
  - `client_order_id` (string): Custom client order ID (36 chars max, unique)
  - `order_tag` (string): Order tag
  - `level` (number): Level for BID/ASK orders (0-4)
  - `post_only_adjust` (boolean): Price adjustment for POST_ONLY orders
- **Required Scope**: `trading` scope in Orderly Key
- **Documentation**: Based on [Create Order API](https://orderly.network/docs/build-on-omnichain/evm-api/restful-api/private/create-order)

---

### 8. Get Orders (`get-orders.js`)

Retrieve orders from Orderly Network with optional filtering and pagination.

#### Usage

```bash
# Using npm script
npm run get-orders [symbol] [side] [orderType] [status] [page] [size]

# Direct execution
node get-orders.js [symbol] [side] [orderType] [status] [page] [size]
```

#### Prerequisites

- `ACCOUNT_ID` or `ORDERLY_ACCOUNT_ID` must be set in `.env` file
- `ORDERLY_KEY` must be set in `.env` file (generated by `add-orderly-key.js`)
- `ORDERLY_PRIVATE_KEY` must be set in `.env` file (generated by `add-orderly-key.js`)
- Account must be registered on Orderly Network
- Orderly Key must be added to your account

#### Examples

```bash
# Get all orders
npm run get-orders

# Get orders for specific symbol
npm run get-orders "PERP_ETH_USDC"

# Get BUY orders
npm run get-orders "PERP_ETH_USDC" "BUY"

# Get LIMIT orders with status NEW
npm run get-orders "PERP_ETH_USDC" "BUY" "LIMIT" "NEW"

# Get orders with pagination
npm run get-orders "PERP_ETH_USDC" undefined undefined undefined 1 50
```

#### Using as a Module

```javascript
const { getOrders } = require("./get-orders");
const { hexToPrivateKey } = require("./orderly-auth");

const accountId = process.env.ACCOUNT_ID;
const orderlyKey = process.env.ORDERLY_KEY;
const orderlyPrivateKey = hexToPrivateKey(process.env.ORDERLY_PRIVATE_KEY);

// Get orders with filters
const result = await getOrders(
  {
    symbol: "PERP_ETH_USDC",
    side: "BUY",
    orderType: "LIMIT",
    status: "NEW",
    page: 1,
    size: 25,
  },
  accountId,
  orderlyKey,
  orderlyPrivateKey
);

console.log(`Found ${result.meta?.total || 0} orders`);
console.log("Orders:", result.orders);
```

#### How It Works

1. Builds query parameters from filter options (all optional)
2. Creates an authenticated request using Orderly API authentication
3. Normalizes the request message (timestamp + method + path)
4. Signs the message with your Orderly private key (ed25519)
5. Sends a GET request to Orderly API with authentication headers and query parameters
6. Returns orders with pagination metadata

#### Example Output

```
Orders retrieved successfully!
Total orders: 10
Page: 1 of 1
Orders in this page: 10

Orders: [
  {
    "order_id": 12345,
    "symbol": "PERP_ETH_USDC",
    "side": "BUY",
    "order_type": "LIMIT",
    "order_price": 2000,
    "order_quantity": 0.1,
    "status": "NEW",
    "created_time": 1702989203989,
    "updated_time": 1702989203989
  },
  ...
]

Orders retrieved successfully!
Total: 10 orders
Showing page 1 (10 orders)
```

#### API Details

- **Get Orders Endpoint**: `GET /v1/orders`
- **Authentication**: Uses Orderly API authentication (orderly-timestamp, orderly-account-id, orderly-key, orderly-signature)
- **Query Parameters** (all optional):
  - `symbol` (string): Trading symbol (e.g., "PERP_ETH_USDC")
  - `side` (string): Order side - "BUY" or "SELL"
  - `order_type` (string): Order type - "LIMIT", "MARKET", "IOC", "FOK", "POST_ONLY", "ASK", "BID"
  - `status` (string): Order status - "NEW", "CANCELLED", "PARTIAL_FILLED", "FILLED", "REJECTED", "INCOMPLETE", "COMPLETED"
  - `order_tag` (string): Order tag
  - `start_t` (number): Start timestamp (13-digit timestamp in milliseconds)
  - `end_t` (number): End timestamp (13-digit timestamp in milliseconds)
  - `page` (number): Page number (starts from 1)
  - `size` (number): Page size (max: 500)
  - `sort_by` (string): Sort by - "CREATED_TIME_DESC", "CREATED_TIME_ASC", "UPDATED_TIME_DESC", "UPDATED_TIME_ASC"
- **Response**: Returns orders array with pagination metadata (total, current_page, records_per_page)
- **Documentation**: Based on [Get Orders API](https://orderly.network/docs/build-on-omnichain/evm-api/restful-api/private/get-orders)

---

### 9. Cancel Order (`cancel-order.js`)

Cancel an existing order on Orderly Network.

#### Usage

```bash
# Using npm script
npm run cancel-order <orderId> <symbol>

# Direct execution
node cancel-order.js <orderId> <symbol>
```

#### Prerequisites

- `ACCOUNT_ID` or `ORDERLY_ACCOUNT_ID` must be set in `.env` file
- `ORDERLY_KEY` must be set in `.env` file (generated by `add-orderly-key.js`)
- `ORDERLY_PRIVATE_KEY` must be set in `.env` file (generated by `add-orderly-key.js`)
- Account must be registered on Orderly Network
- Orderly Key must be added to your account with `trading` scope
- Order must exist and be cancellable

#### Examples

```bash
# Cancel order with ID 12345 for PERP_ETH_USDC
npm run cancel-order 12345 "PERP_ETH_USDC"

# Cancel order with different symbol
npm run cancel-order 67890 "PERP_BTC_USDC"
```

#### Using as a Module

```javascript
const { cancelOrder } = require("./cancel-order");
const { hexToPrivateKey } = require("./orderly-auth");

const accountId = process.env.ACCOUNT_ID;
const orderlyKey = process.env.ORDERLY_KEY;
const orderlyPrivateKey = hexToPrivateKey(process.env.ORDERLY_PRIVATE_KEY);

// Cancel order
const result = await cancelOrder(
  12345, // order ID
  "PERP_ETH_USDC", // symbol
  accountId,
  orderlyKey,
  orderlyPrivateKey
);

console.log("Cancel result:", result);
console.log("Status:", result.status); // e.g., "CANCEL_SENT"
```

#### How It Works

1. Validates required parameters (orderId and symbol)
2. Creates an authenticated request using Orderly API authentication
3. Normalizes the request message (timestamp + method + path)
4. Signs the message with your Orderly private key (ed25519)
5. Sends a DELETE request to Orderly API with authentication headers
6. Returns the cancellation status

#### Example Output

```
Cancelling order 12345 for symbol PERP_ETH_USDC...
Order cancelled successfully!
Response: {
  "success": true,
  "timestamp": 1702989203989,
  "data": {
    "status": "CANCEL_SENT"
  }
}

Order cancelled successfully!
Order ID: 12345
Symbol: PERP_ETH_USDC
Status: CANCEL_SENT
```

#### API Details

- **Cancel Order Endpoint**: `DELETE /v1/order?order_id={order_id}&symbol={symbol}`
- **Authentication**: Uses Orderly API authentication (orderly-timestamp, orderly-account-id, orderly-key, orderly-signature)
- **Required Query Parameters**:
  - `order_id` (number): Order ID to cancel
  - `symbol` (string): Trading symbol (e.g., "PERP_ETH_USDC")
- **Response**: Returns order status (e.g., "CANCEL_SENT")
- **Rate Limit**: 10 requests per 1 second
- **Required Scope**: `trading` scope in Orderly Key
- **Documentation**: Based on [Cancel Order API](https://orderly.network/docs/build-on-omnichain/evm-api/restful-api/private/cancel-order)

---

## Supported Chains

Based on the Orderly documentation, you can register on any EVM-compatible chain that Orderly supports. Common options include:

| Chain                   | Chain ID   | Type    |
| ----------------------- | ---------- | ------- |
| Ethereum Mainnet        | `1`        | Mainnet |
| Ethereum Sepolia        | `11155111` | Testnet |
| Arbitrum One            | `42161`    | Mainnet |
| Arbitrum Sepolia        | `421614`   | Testnet |
| Optimism                | `10`       | Mainnet |
| Optimism Sepolia        | `11155420` | Testnet |
| Base                    | `8453`     | Mainnet |
| Base Sepolia            | `84532`    | Testnet |
| Mantle                  | `5000`     | Mainnet |
| Mantle Sepolia          | `5003`     | Testnet |
| BNB Smart Chain         | `56`       | Mainnet |
| BNB Smart Chain Testnet | `97`       | Testnet |

For a complete list of supported chains and contract addresses, see the [Orderly addresses documentation](https://orderly.network/docs/build-on-omnichain/addresses).

## Error Handling

All scripts handle common errors:

- **Account already exists**: Registration script will skip registration if account exists
- **Invalid private key**: Registration script will fail with clear error message
- **API connection errors**: All scripts handle network errors gracefully
- **Invalid parameters**: Scripts validate inputs and provide usage instructions
- **Registration failures**: Registration script provides detailed error messages from API

## Security Notes

⚠️ **Important Security Considerations:**

- **Never commit your private key to version control!** Always use environment variables or secure secret management
- The `.env` file is automatically ignored by git (see `.gitignore`)
- Use `.env.example` as a template without sensitive values
- Consider using a testnet for development and testing
- Keep your private keys secure and never share them

## Development

### Project Structure

```
orderly/
├── check-account.js      # Check account existence script
├── register-account.js   # Register account script
├── add-orderly-key.js    # Add/announce Orderly Key script
├── remove-orderly-key.js # Remove/revoke Orderly Key script
├── deposit.js            # Deposit USDC to Orderly account script
├── withdraw.js           # Withdraw funds from Orderly account script
├── create-order.js       # Create order script
├── get-orders.js         # Get orders script
├── cancel-order.js       # Cancel order script
├── orderly-auth.js       # Shared authentication module for Orderly API
├── package.json          # Dependencies and scripts
├── .env                  # Environment variables (not in git)
├── .env.example          # Example environment variables
└── README.md            # This file
```

### Adding New Scripts

To add a new script:

1. Create a new `.js` file (e.g., `new-script.js`)
2. Add the npm script to `package.json`:
   ```json
   "scripts": {
     "new-script": "node new-script.js"
   }
   ```
3. Update this README with documentation for the new script
4. Follow the existing patterns for:
   - Environment variable configuration
   - Error handling
   - Module exports
   - CLI argument parsing

### Dependencies

- `ethers`: Ethereum library for wallet operations, EIP-712 signing, and blockchain interactions
- `@noble/ed25519`: ed25519 cryptographic primitives for Orderly Key generation and signing
- `bs58`: Base58 encoding for Orderly Key encoding
- `dotenv`: Load environment variables from `.env` file
- `node-fetch`: HTTP client (fallback for Node.js < 18)

### Shared Authentication Module

The `orderly-auth.js` module provides shared authentication functionality for Orderly API requests:

- `createOrderlySignature(message, privateKey)`: Creates ed25519 signatures in base64url format
- `normalizeRequestMessage(timestamp, method, path, body)`: Normalizes request content for signing
- `getContentType(method)`: Returns correct Content-Type based on HTTP method
- `createAuthenticatedRequest(method, path, body, accountId, orderlyKey, orderlyPrivateKey)`: Creates authenticated fetch request configuration
- `hexToPrivateKey(privateKeyHex)`: Converts hex string to Uint8Array

This module is used by `withdraw.js`, `remove-orderly-key.js`, `create-order.js`, `get-orders.js`, and `cancel-order.js` to handle Orderly API authentication according to the [Orderly API authentication documentation](https://orderly.network/docs/build-on-omnichain/evm-api/api-authentication).

## License

ISC
